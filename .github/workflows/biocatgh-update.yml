name: Update Bioc@GH

on:
  workflow_dispatch:
  schedule:
    - cron:  '27 1 * * *'

jobs:
  gh-update:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/r-hub/biocatgh/biocatgh:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      env:
        BIOCATGH_GITHUB_TOKEN: ${{ secrets.BIOCATGH_GITHUB_TOKEN }}
        GITHUB_PAT: ${{ secrets.BIOCATGH_GITHUB_TOKEN }}

    steps:
      - name: Git config
        run: |
          git config --global user.email "csardi.gabor+bioc@gmail.com"
          git config --global user.name "BIOC@GH robot"
          git config --global credential.helper 'cache --timeout 21600'
      - name: Update outdated packages
        run: |
          gitcreds::gitcreds_approve(list(
            url = "https://github.com",
            username = "PersonalAccessToken",
            password = Sys.getenv("GITHUB_PAT")
          ))
          biocatgh::update_all()
        shell: Rscript {0}
        env:
          BIOCATGH_GITHUB_TOKEN: ${{ secrets.BIOCATGH_GITHUB_TOKEN }}
          GITHUB_PAT: ${{ secrets.BIOCATGH_GITHUB_TOKEN }}

  keep-alive:
    runs-on: ubuntu-latest
    needs: gh-update
    if: always()
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update activity timestamp
        run: |
          git checkout -B activity-log
          mkdir -p .github
          date > .github/last-run.txt
          git add .github/last-run.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update activity timestamp [skip ci]"
          git push origin activity-log --force
